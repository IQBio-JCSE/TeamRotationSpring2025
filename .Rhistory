}
library(doMC)
registerDoMC(cores = n_cores)
list_simulation <- design %>% select(id)
output <- list_simulation %>%
plyr::mdply(possibly(run_single_simulation, NULL), design = design) %>%
as_tibble()
return(output)
}
#' Calculate crop performance indicators
#' @param simulation_results Simulation results data frame
#' @return Data frame with performance indicators
calculate_indicators <- function(simulation_results) {
output_indicators <- simulation_results %>%
group_by(id) %>%
do(indicate(.)) %>%
ungroup()
return(output_indicators)
}
#' Plot simulation results
#' @param results Simulation results
#' @param indicator Indicator to plot
plot_results <- function(results, indicator) {
ggplot(results, aes(x = id, y = !!sym(indicator))) +
geom_point() +
geom_line() +
theme_minimal() +
labs(title = paste("SUNFLO Simulation Results -", indicator),
x = "Simulation ID",
y = indicator)
}
main <- function() {
# Install and check requirements
install_required_packages()
check_sunflo_model()
# Load design of experiments
design <- readRDS("inst/doc/files/design.rds")
# Initialize model
sunflo <- initialize_sunflo()
# Run default simulation
default_results <- sunflo %>%
run() %>%
results() %>%
shape(view = "timed")
# Display default results
display(default_results)
# Run parallel simulations
simulation_results <- run_parallel_simulations(design)
# Calculate indicators
performance_indicators <- calculate_indicators(simulation_results)
# Plot results (example with yield indicator)
if ("yield" %in% names(performance_indicators)) {
p <- plot_results(performance_indicators, "yield")
print(p)
}
return(list(
default_results = default_results,
simulation_results = simulation_results,
performance_indicators = performance_indicators
))
}
# Execute main function if script is run directly
if (!interactive()) {
results <- main()
}
interactive
# Execute main function if script is run directly
if (!interactive()) {
results <- main()
}
library(rvle)
library(rsunflo)
# packages
library(tidyverse)
library(rvle)
library(rsunflo)
library("devtools")
devtools::install_github("picasa/rsunflo")
library(rsunflo)
# load design of experiments
design <- readRDS("inst/doc/files/design.rds")
?readRDS
# load the sunflo model
sunflo <- new("Rvle", file = "sunflo_web.vpz", pkg = "sunflo")
library(rvle)
devtools::install_github("picasa/rsunflo")
library(rvle)
.onLoad <- function(lib, pkg)
{
library.dynam("rvle", pkg, lib)
x = .Call("__rvleC_onload", PACKAGE="rvle")
}
rvle.open <- function(file, pkg = "")
{
stopifnot(is.character(file))
stopifnot(is.character(pkg))
if (pkg == "")
x <- .Call("rvleC_open", file, PACKAGE="rvle")
else
x <- .Call("rvleC_open_pkg", file, pkg, PACKAGE="rvle")
stopifnot(!is.null(x))
class(x) <- 'rvle'
return(x)
}
is.rvle <- function(object)
{
inherits(object, "rvle")
}
rvle.packages_list <- function()
{
x <- .Call("rvleC_packages_list", PACKAGE="rvle")
return(x)
}
rvle.package_content <- function(pkgname)
{
stopifnot(is.character(pkgname))
x <- .Call("rvleC_package_content", pkgname, PACKAGE="rvle")
return(x)
}
rvle.save <- function(vleObj, filename)
{
stopifnot(is.rvle(vleObj))
stopifnot(is.character(filename))
.Call("rvleC_save", vleObj, filename, PACKAGE="rvle")
return (invisible(NULL))
}
rvle.get_log_level <- function(vleObj)
{
stopifnot(is.rvle(vleObj))
x = .Call("rvleC_get_log_level", vleObj, PACKAGE="rvle")
return (x)
}
rvle.set_log_level <- function(vleObj, level)
{
stopifnot(is.rvle(vleObj))
.Call("rvleC_set_log_level", vleObj, as.integer(level), PACKAGE="rvle")
return (invisible(NULL))
}
rvle.get_atomic_models = function(vleObj)
{
stopifnot(is.rvle(vleObj))
x = .Call("rvleC_get_atomic_models", vleObj, PACKAGE="rvle")
return(x)
}
rvle.get_conditions = function(vleObj)
{
stopifnot(is.rvle(vleObj))
x = .Call("rvleC_get_conditions", vleObj, PACKAGE="rvle")
return(x)
}
rvle.add_condition = function(vleObj, condition)
{
stopifnot(is.rvle(vleObj))
stopifnot(is.character(condition))
.Call("rvleC_add_condition", vleObj, condition, PACKAGE="rvle")
return (invisible(NULL))
}
rvle.del_condition = function(vleObj, condition)
{
stopifnot(is.rvle(vleObj))
stopifnot(is.character(condition))
.Call("rvleC_add_condition", vleObj, condition, PACKAGE="rvle")
return (invisible(NULL))
}
rvle.get_attached_conditions = function(vleObj, atomicpath)
{
stopifnot(is.rvle(vleObj))
stopifnot(is.character(atomicpath))
x = .Call("rvleC_get_attached_conditions", vleObj, atomicpath,
PACKAGE="rvle")
return(x)
}
rvle.attach_condition = function(vleObj, atomicpath, condition)
{
stopifnot(is.rvle(vleObj))
.Call("rvleC_attach_condition", vleObj, atomicpath, condition,
PACKAGE="rvle")
return (invisible(NULL))
}
rvle.detach_condition = function(vleObj, atomicpath, condition)
{
stopifnot(is.rvle(vleObj))
.Call("rvleC_detach_condition", vleObj, atomicpath, condition,
PACKAGE="rvle")
return (invisible(NULL))
}
rvle.get_condition_ports = function(vleObj, condition)
{
stopifnot(is.rvle(vleObj))
x = .Call("rvleC_get_condition_ports", vleObj, condition,
PACKAGE="rvle")
return(x)
}
rvle.add_condition_port = function(vleObj, condition, port)
{
stopifnot(is.rvle(vleObj))
.Call("rvleC_add_condition_port", vleObj, condition, port,
PACKAGE="rvle")
return (invisible(NULL))
}
rvle.del_condition_port = function(vleObj, condition, port)
{
stopifnot(is.rvle(vleObj))
.Call("rvleC_del_condition_port", vleObj, condition, port,
PACKAGE="rvle")
return (invisible(NULL))
}
rvle.get_condition_port_value = function(vleObj, condition, port)
{
stopifnot(is.rvle(vleObj))
x = .Call("rvleC_get_condition_port_value", vleObj, condition, port,
PACKAGE="rvle")
return(x)
}
rvle.set_condition_port_value = function(vleObj, condition, port, val)
{
stopifnot(is.rvle(vleObj))
.Call("rvleC_set_condition_port_value", vleObj, as.character(condition),
as.character(port), val, PACKAGE="rvle")
return (invisible(NULL))
}
rvle.get_observables = function(vleObj)
{
stopifnot(is.rvle(vleObj))
x = .Call("rvleC_get_observables", vleObj, PACKAGE="rvle")
return(x)
}
rvle.get_observable_ports = function(vleObj, observable)
{
stopifnot(is.rvle(vleObj))
x = .Call("rvleC_get_observable_ports", vleObj, observable, PACKAGE="rvle")
return(x)
}
rvle.add_observable_port = function(vleObj, observable, port)
{
stopifnot(is.rvle(vleObj))
.Call("rvleC_add_observable_port", vleObj, observable, port, PACKAGE="rvle")
return (invisible(NULL))
}
rvle.del_observable_port = function(vleObj, observable, port)
{
stopifnot(is.rvle(vleObj))
.Call("rvleC_del_observable_port", vleObj, observable, port, PACKAGE="rvle")
return (invisible(NULL))
}
rvle.attach_view = function(vleObj, view, observable, port)
{
stopifnot(is.rvle(vleObj))
.Call("rvleC_attach_view", vleObj, view, observable, port, PACKAGE="rvle")
return (invisible(NULL))
}
rvle.detach_view = function(vleObj, view, observable, port)
{
stopifnot(is.rvle(vleObj))
.Call("rvleC_detach_view", vleObj, view, observable, port, PACKAGE="rvle")
return (invisible(NULL))
}
rvle.get_attached_views = function(vleObj, observable, port)
{
stopifnot(is.rvle(vleObj))
x = .Call("rvleC_get_attached_views", vleObj, observable, port,
PACKAGE="rvle")
return(x)
}
rvle.get_views = function(vleObj)
{
stopifnot(is.rvle(vleObj))
x = .Call("rvleC_get_views", vleObj, PACKAGE="rvle")
return(x)
}
rvle.add_view = function(vleObj, view)
{
stopifnot(is.rvle(vleObj))
.Call("rvleC_add_view", vleObj, view, PACKAGE="rvle")
return (invisible(NULL))
}
rvle.del_view = function(vleObj, view)
{
stopifnot(is.rvle(vleObj))
.Call("rvleC_del_view", vleObj, view, PACKAGE="rvle")
return (invisible(NULL))
}
rvle.get_view_config = function(vleObj, view)
{
stopifnot(is.rvle(vleObj))
x = .Call("rvleC_get_view_config", vleObj, view, PACKAGE="rvle")
return(x)
}
rvle.set_view_config = function(vleObj, view, config)
{
stopifnot(is.rvle(vleObj))
.Call("rvleC_set_view_config", vleObj, view, config, PACKAGE="rvle")
return (invisible(NULL))
}
rvle.get_view_plugin = function(vleObj, view)
{
stopifnot(is.rvle(vleObj))
x = .Call("rvleC_get_view_plugin", vleObj, view, PACKAGE="rvle")
return(x)
}
rvle.set_view_plugin = function(vleObj, view, pluginname,
package="vle.output")
{
stopifnot(is.rvle(vleObj))
.Call("rvleC_set_view_plugin", vleObj, view, pluginname, package,
PACKAGE="rvle")
return (invisible(NULL))
}
rvle.available_outputs = function(vleObj)
{
stopifnot(is.rvle(vleObj))
x = .Call("rvleC_available_outputs", vleObj, PACKAGE="rvle")
return(x)
}
rvle.run = function(vleObj)
{
stopifnot(is.rvle(vleObj))
x = .Call("rvleC_run", vleObj, PACKAGE="rvle")
return(x)
}
rvle.manager_clear = function(vleObj)
{
stopifnot(is.rvle(vleObj))
.Call("rvleC_manager_clear", vleObj, PACKAGE="rvle")
return (invisible(NULL))
}
rvle.manager_get_config = function(vleObj)
{
stopifnot(is.rvle(vleObj))
x = .Call("rvleC_manager_get_config", vleObj, PACKAGE="rvle")
return(x)
}
rvle.manager_set_config = function(vleObj, parallel_option="single",
nb_slots=1, simulation_spawn=T,
rm_MPI_files=T, generate_MPI_host=F,
working_dir="/tmp/")
{
stopifnot(is.rvle(vleObj))
.Call("rvleC_manager_set_config", vleObj, as.character(parallel_option),
as.integer(nb_slots), as.logical(simulation_spawn),
as.logical(rm_MPI_files), as.logical(generate_MPI_host),
as.character(working_dir), PACKAGE="rvle")
return (invisible(NULL))
}
rvle.plan_clear = function(vleObj)
{
stopifnot(is.rvle(vleObj))
.Call("rvleC_plan_clear", vleObj, PACKAGE="rvle")
return (invisible(NULL))
}
rvle.plan_get = function(vleObj)
{
stopifnot(is.rvle(vleObj))
x = .Call("rvleC_plan_get", vleObj, PACKAGE="rvle")
return(x)
}
rvle.plan_define = function(vleObj, cond, port, addORremove)
{
stopifnot(is.rvle(vleObj))
.Call("rvleC_plan_define", vleObj, cond, port, as.logical(addORremove),
PACKAGE="rvle")
return (invisible(NULL))
}
rvle.plan_input = function(vleObj, cond, port, val)
{
stopifnot(is.rvle(vleObj))
.Call("rvleC_plan_input", vleObj, cond, port, val,
PACKAGE="rvle")
return (invisible(NULL))
}
rvle.plan_propagate = function(vleObj, cond, port, val)
{
stopifnot(is.rvle(vleObj))
.Call("rvleC_plan_propagate", vleObj, cond, port, val, PACKAGE="rvle")
return (invisible(NULL))
}
rvle.plan_replicate = function(vleObj, cond, port, val)
{
stopifnot(is.rvle(vleObj))
.Call("rvleC_plan_replicate", vleObj, cond, port, val, PACKAGE="rvle")
return (invisible(NULL))
}
rvle.plan_output = function(vleObj, id, path,
integration="all", aggregation_replicate="mean",
aggregation_input="all", obs_times=NULL,
obs_values=NULL, replicate_quantile=0.5)
{
stopifnot(is.rvle(vleObj))
.Call("rvleC_plan_output", vleObj, as.character(id), as.character(path),
as.character(integration), as.character(aggregation_replicate),
as.character(aggregation_input), as.numeric(obs_times),
as.numeric(obs_values), as.numeric(replicate_quantile), PACKAGE="rvle")
return (invisible(NULL))
}
# check if the required packages are installed
if (!requireNamespace("tidyverse", quietly = TRUE)) {
install.packages("tidyverse")
}
if (!requireNamespace("lubridate", quietly = TRUE)) {
install.packages("lubridate")
}
if (!requireNamespace("testthat", quietly = TRUE)) {
install.packages("testthat")
}
if (!requireNamespace("ggplot2", quietly = TRUE)) {
install.packages("ggplot2")
}
if (!requireNamespace("dplyr", quietly = TRUE)) {
install.packages("dplyr")
}
# Load the required packages
library(tidyverse)
library(lubridate)
library(testthat)
library(ggplot2)
library(dplyr)
# Load script model
source("All_Rsunflo_Files.R")
wd()
getwd()
# Load script model
source("rsunflo-master/R/All_Rsunflo_Files.R")
# Load script model
source("rsunflo-master/R/All_Rsunflo_Files.R")
# Load script model
source("rsunflo-master/R/All_Rsunflo_Files.R")
result <- play(data = design, model = sunflo, unit = 1)
# load design of experiments
design <- readRDS("inst/doc/files/design.rds")
?readRDS
# load design of experiments
design <- readRDS("rsunflo-master/inst/doc/files/design.rds")
View(design)
result <- play(data = design, model = sunflo, unit = 1)
?play
??play
# Load script model
source("rsunflo-master/R/All_Rsunflo_Files.R")
# load design of experiments
design <- readRDS("rsunflo-master/inst/doc/files/design.rds")
# Run the sunflo model
play <- function(data, model = sunflo_model, unit) {
# Get the design row for the specified unit
design_row <- data %>% slice(unit)
# Load climate data (replace with actual climate data loading logic)
climate_data <- readRDS("rsunflo-master/inst/doc/files/climate_data.rds")
# Run the model
output <- model(design_row, climate_data)
return(output)
}
# Run the model for a single unit
result <- play(data = design, unit = 1)
View(design)
# check if the required packages are installed
if (!requireNamespace("tidyverse", quietly = TRUE)) {
install.packages("tidyverse")
}
if (!requireNamespace("lubridate", quietly = TRUE)) {
install.packages("lubridate")
}
if (!requireNamespace("testthat", quietly = TRUE)) {
install.packages("testthat")
}
if (!requireNamespace("ggplot2", quietly = TRUE)) {
install.packages("ggplot2")
}
if (!requireNamespace("dplyr", quietly = TRUE)) {
install.packages("dplyr")
}
# Load the required packages
library(tidyverse)
library(lubridate)
library(testthat)
# Load script model
source("rsunflo-master/R/All_Rsunflo_Files.R")
# load design of experiments
design <- readRDS("rsunflo-master/inst/doc/files/design.rds")
# Run the sunflo model
play <- function(data, model = sunflo_model, unit) {
# Get the design row for the specified unit
design_row <- data %>% slice(unit)
# Load climate data (replace with actual climate data loading logic)
climate_data <- readRDS("rsunflo-master/inst/doc/files/climate_data.rds")
# Run the model
output <- model(design_row, climate_data)
return(output)
}
# Load design of experiments
design <- readRDS("rsunflo-master/inst/doc/files/design.rds")
# Run the model for a single unit
result <- play(data = design, unit = 1)
View(design)
# load excel file with multiple tabs
climate_data <- read.csv("sunflo-master/sunflo/data/AUZ_2014.txt")
View(climate_data)
# load txt file with multiple tabs
climate_data <- read.table("sunflo-master/sunflo/data/AUZ_2014.txt", header = TRUE, sep = "\t")
View(climate_data)
# Run the sunflo model
play <- function(data, model = sunflo_model, unit) {
# Get the design row for the specified unit
design_row <- data %>% slice(unit)
# Load climate data (replace with actual climate data loading logic)
climate_data <- read.table("sunflo-master/sunflo/data/AUZ_2014.txt", header = TRUE, sep = "\t")
# Run the model
output <- model(design_row, climate_data)
return(output)
}
# Load design of experiments
design <- readRDS("rsunflo-master/inst/doc/files/design.rds")
# Run the model for a single unit
result <- play(data = design, unit = 1)
